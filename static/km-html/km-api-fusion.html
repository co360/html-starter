<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>HTML/CSS/JavaScript Starter</title>
    <script src="/ojet-starter/web/js/libs/jquery/jquery-3.3.1.js"></script>
    <script>
        $(function() {
            // KM Parameters
            let restParamsMap = {
                day380_19201_sql_249h: {
                    baseUrl: "https://day380-19201-sql-249h-irs.dq.lan/km/api/latest",
                    siteName: "day380_19201_sql_249h",
                    integrationLogin: "iu_agent_desktop",
                    integrationPassword: "03D7E12D329A4B38AA34AC4454D3C6A4",
                    userName: "administrator",
                    userPassword: "Welcome@123"
                },
                den00omm: {
                    baseUrl: "http://den00omm.us.oracle.com:7202/km/api/latest",
                    siteName: "fusion",
                    integrationLogin: "iu_fusion",
                    integrationPassword: "Welcome1",
                    userName: "provisioning",
                    userPassword: "Welcome1"
                }
            };

            // Perform KM Auth and then Get Content
            let restParams = restParamsMap['den00omm'];
            let integrationUserToken = "";
            let endUserToken = "";

            // KM Integration Auth
            // NOTE: We will use sync mode to perform REST call!
            $.ajax({
                async: false,
                url : restParams.baseUrl + "/auth/integration/authorize",
                method: "POST",
                dataType: 'json',
                contentType: 'application/json',
                headers: {
                    'kmauthtoken' : JSON.stringify({
                        siteName : restParams.siteName
                    })
                },
                data: JSON.stringify({
                    "login" : restParams.integrationLogin,
                    "password" : restParams.integrationPassword
                })
            }).done(integrationData => {
                console.log("Result /auth/integration/authorize", integrationData);
                integrationUserToken = integrationData.authenticationToken;
            });

            // KM User Auth
            $.ajax({
                async: false,
                url: restParams.baseUrl + "/auth/authorize",
                method: "POST",
                dataType: 'json',
                contentType: false,
                headers: {
                    'kmauthtoken': JSON.stringify({
                        "siteName": restParams.siteName,
                        "integrationUserToken": integrationUserToken
                    })
            },
            data: {
                "userName" : restParams.userName,
                "password" : restParams.userPassword,
                "userExternalType" : "ACCOUNT",
                "siteName" : restParams.siteName
            }
            }).done(endUserData => {
                console.log("Result /auth/authorize", endUserData);
                let tokenResponse = endUserData.authenticationToken;
                let parsedToken = JSON.parse(tokenResponse);
                endUserToken = parsedToken.userToken;
            });

            // // == Test Only
            // // We can also manually setup Token for testing (eg: Using REST Client to get
            // // get token manually.)
            // integrationUserToken = "ZnVzaW9uOnRlTWxQZjVidDduejdONHB6OFF3K0I0Y0JRcUxnbXVUcktTQVdjODJUR3k0SEVBMlJkRlpjYVlvS0dnS0NiK3RSMGs1bzFpejRRNkswdEJqT3FlMGhCWTVtUkI3TWVveVhNNC95RDhFUEJsOERKZThKenVvam5xMnBpSVFaVlh3Nzgyb1AwclUzdStOVVlITmNTZjc0NExhaE9lY3k0MHZZOUNSYkFjM1BIVEgwdW83U0l4dXdJdEQrWTh5cWVWMA==";
            // endUserToken = "f5wDY3ju8Ctd+DFlnhKx/DtT+1L2HQaxE7wcyg+B62iYQKuiubgYj1LO3Z1IRDea/bExu+C/8eZkbixfVj9s42fuAxTwHmtZ2IsopxHZI8GY5ww5GzUlv/LkkAPWc0bn1CMhSu/kTbFOV9fxfcTDpA==";
            // // == Test Only

            // Create kmauthtoken
            let kmauthtoken = JSON.stringify({
                siteName : restParams.siteName,
                userToken : endUserToken,
                integrationUserToken: integrationUserToken
            });
            console.log("KM HEADER kmauthtoken:", kmauthtoken);

            // Fetch Data
            $.ajax({
                url : restParams.baseUrl + "/content",
                method: "GET",
                dataType: 'json',
                headers: { 'kmauthtoken' : kmauthtoken }
            }).done(kmResponse => {
                console.log("Result /content");
                console.log(kmResponse);
            });
        });
    </script>
</head>
<body>
<pre>AJAX_OUTPUT_HERE</pre>
</body>
</html>
